Description: "This cloudformation template creates AWS VPC, Bastion host, Amazon Redshift and Matillion stacks."
Metadata:
  LICENSE: EULA - Matillion ETL for Redshift
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: End User License Agreement (EULA) - Matillion ETL for Redshift
      Parameters:
      - AcceptedEULA
    - Label:
        default: Network configuration
      Parameters:
      - AvailabilityZones
      - VPCCIDR
      - PrivateSubnet1CIDR
      - PrivateSubnet2CIDR
      - PublicSubnet1CIDR
      - PublicSubnet2CIDR
    - Label:
        default: Linux bastion configuration
      Parameters:
       - EnableBastion
       - RemoteAccessCIDR
    - Label:
        default: Matillion EC2 Instance and ALB Configuration 
      Parameters:
      - MatillionEC2InstanceType
      - KeyPairName
      - LBDnsName
    - Label:
        default: Matillion RDS/Postgres Repository configuration
      Parameters:
      - PGMasterUsername
      - PGMasterUserPassword
      - PGDBPort
      - PGDBName
      - PGInstanceClass
      - PGAllocatedStorage
      - PGAutoMinorVersionUpgrade
    - Label:
        default: Amazon Redshift Configuration
      Parameters:
      - NewRedshiftCluster
      - RedshiftDBName
      - RedshiftDBPort
      - RedshiftNodeType
      - RedshiftNumberOfNodes
      - RedshiftMasterUsername
      - RedshiftMasterUserPassword
      - RedshiftEnableLoggingToS3
      - RedshiftMaxConcurrentCluster
      - RedshiftEncryptionAtRest
      - Redshiftkmskey
      - RedshiftS3BucketForIAMRole
      - RedshiftNotificationList
      - RedshiftMaintenancewindow
      - RedshiftSnapshotIdentifier
      - RedshiftSnapshotAccountNumber
    - Label:
        default: Matillion-ETL Realm Configuration
      Parameters:
      - MatillionRealmConName
      - MatillionRealmConPass
      - MatillionRealmConURL
      - MatillionRealmUserBase
      - MatillionRealmUserSearch
      - MatillionRealmRoleBase
      - MatillionRealmRoleName
      - MatillionRealmRoleSearch
      - MatillionRealmUserSubtree
      - MatillionRealmMETLRole
      - MatillionRealmMETLAdminRole
      - MatillionRealmMETLAPIRole
    - Label:
        default: Quick Start configuration
      Parameters:
      - QSS3BucketName
      - QSS3KeyPrefix
    ParameterLabels:
      AcceptedEULA:
        default: Have you accepted EULA from AWS Marketplace link https://aws.amazon.com/marketplace/pp/B010ED5YF8?
      PGAllocatedStorage:
        default: Storage Size
      MatillionEC2InstanceType:
        default: Matillion Instance Type
      KeyPairName:
        default: Keypair Name
      LBDnsName:
        default: ALB DNS Prefix
      PGDBName:
        default: Matillion PostgreSQL Database Name
      PGMasterUserPassword:
        default: PostgreSQL Master Password
      PGDBPort:
        default: PostgreSQL DB Port
      PGMasterUsername:
        default: PostgreSQL Master Username
      PrivateSubnet1:
        default: Private Subnet 1
      PrivateSubnet2:
        default: Private Subnet 2 
      PGInstanceClass:
        default: PostgreSQL Instance Class
      PGAutoMinorVersionUpgrade:
         default: Postgres auto minor version upgrade 
      EnableBastion:
        default: Create bastion stack
      PrivateSubnet1CIDR:
        default: Private subnet 1 CIDR
      PrivateSubnet2CIDR:
        default: Private subnet 2 CIDR
      PublicSubnet1CIDR:
        default: Public subnet 1 CIDR
      PublicSubnet2CIDR:
        default: Public subnet 2 CIDR
      QSS3BucketName:
        default: Quick Start S3 bucket name
      QSS3KeyPrefix:
        default: Quick Start S3 key prefix
      VPCCIDR:
        default: VPC CIDR
      NewRedshiftCluster:
        default: Do you want to create Redshift cluster stack? 
      RedshiftDBName:
        default: Redshift Database Name
      RedshiftDBPort:
        default: Redshift Database Port
      RedshiftNodeType:
        default: Node Type for Redshift Cluster
      RedshiftNumberOfNodes:
        default: Number Of Nodes in Redshift Cluster
      RedshiftMasterUsername:
        default: Redshift Master User Name
      RedshiftMasterUserPassword:
        default: Redshift Master User Password
      RedshiftEnableLoggingToS3:
        default: Enable Audit Logging to Amazon S3 for Redshift Database?
      RedshiftMaxConcurrentCluster:
        default: Maximum number of Concurrent Cluster for Redshift
      RedshiftEncryptionAtRest:
        default: Enable Encryption at rest?
      Redshiftkmskey:
        default: KMS Key for Encryption at rest
      RedshiftS3BucketForIAMRole:
        default: Amazon S3 Bucket for Redshift IAM Role 
      RedshiftNotificationList:
        default: Email address for SNS notification
      RedshiftMaintenancewindow:
        default: Redshift Maintenance window
      RedshiftSnapshotIdentifier:
        default: Redshift Snapshot Identifier to restore Redshift cluster
      RedshiftSnapshotAccountNumber:
        default: AWS Account-ID where the Redshift snapshot was created
      MatillionRealmConName:
        default: Username
      MatillionRealmConPass:
        default: Connection Password
      MatillionRealmConURL:
        default: URL
      MatillionRealmMETLAPIRole:
        default: API Role
      MatillionRealmMETLAdminRole:
        default: Admin Role
      MatillionRealmMETLRole:
        default: Login Role
      MatillionRealmRoleBase:
        default: Role Base
      MatillionRealmRoleName:
        default: Role Name
      MatillionRealmRoleSearch:
        default: Role Search
      MatillionRealmUserBase:
        default: User Base
      MatillionRealmUserSearch:
        default: User Search
      MatillionRealmUserSubtree:
        default: User Subtree
        
Parameters:
    
  AcceptedEULA: 
    AllowedValues: 
      - "Yes"
      - "No"
    Default: "No"
    Description: >- 
        PLEASE READ EULA (https://redshift-support.matillion.com/s/article/2845300) CAREFULLY BEFORE USING THE SOFTWARE.
        Matillion stack can be created only if you have already accepted the EULA of using Matillion ETL for Redshift.
        For accepting EULA, visit AWS marketplace link - https://aws.amazon.com/marketplace/pp/B010ED5YF8.     
    Type: String
    
  VPCCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/16
    Description: CIDR block for the VPC.
    Type: String
    
  AvailabilityZones:
   Description: >-
      List of Availability Zones to use for the subnets in the VPC. Only two
      Availability Zones are used for this deployment, and the logical order of
      your selections is preserved.
   Type: 'List<AWS::EC2::AvailabilityZone::Name>'
    
  PrivateSubnet1CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/19
    Description: CIDR block for private subnet 1 located in Availability Zone 1.
    Type: String
    
  PrivateSubnet2CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.32.0/19
    Description: CIDR block for private subnet 2 located in Availability Zone 2.
    Type: String
    
  PublicSubnet1CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.128.0/20
    Description: CIDR block for the public subnet 1 located in Availability Zone 1.
    Type: String
    
  PublicSubnet2CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.144.0/20
    Description: CIDR block for the public subnet 2 located in Availability Zone 2.
    Type: String
    
  RemoteAccessCIDR:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/([0-9]|[1-2][0-9]|3[0-2]))$"
    ConstraintDescription: "CIDR block parameter must be in the form x.x.x.x/x"
    Description: "Allowed CIDR block for external access to ALB and SSH access to bastion host."
    Type: String
    
  EnableBastion: 
    AllowedValues: 
      - "true"
      - "false"
    Default: "true"
    Description: "If true, a bastion stack will be created."
    Type: String
   
  KeyPairName:
    ConstraintDescription: "Name of an existing EC2 key pair."
    Description: Name of an existing public/private key pair, for connecting to your EC2 instance.
    Type: "AWS::EC2::KeyPair::KeyName"
    
  MatillionEC2InstanceType:
    AllowedValues:
    - m5.large
    - m5.xlarge
    Default: m5.large
    Description: Matillion instance(s) size. Larger sizes allow for running more concurrent
      tasks, See https://www.matillion.com/pricing/etl-for-redshift/ for more info.
    Type: String
    
  LBDnsName:
    Default: matillion
    Description: 'Load Balancer DNS Name Prefix, Example: [matillion]-1731869672.eu-west-1.elb.amazonaws.com'
    Type: String
    
  PGDBName:
    AllowedPattern: "([a-z]|[0-9])+"
    Default: matillion
    Description: The Postgres database in which Matillion will store its metadata
      repository.
    Type: String
    
  PGMasterUserPassword:
    AllowedPattern: "^(?=.*\\d)(?=.*[a-z])(?=.*[A-Z]).{8,64}$"
    Description: Postgres Password. Must contain one upper and one lower case letter
      and one digit but not quotes, slashes, @ or spaces.
    NoEcho: true
    Default: 'Welcome123'
    Type: String
    
  PGDBPort:
    Default: '8201'
    Description: Specify the TCP/IP port that the DB instance will use for application
      connections.
    MaxValue: 65535
    MinValue: 1150
    Type: Number
    
  PGMasterUsername:
    AllowedPattern: "^[a-zA-Z]{1}[a-z0-9]*"
    Default: matillion
    Description: Initial Postgres Username. This user will be an admin role.
    Type: String
    
  PGInstanceClass:
    AllowedValues:
    - db.t2.medium
    - db.t2.large
    - db.m4.large
    - db.m4.xlarge
    Default: db.m4.large
    Description: "Postgres Database instance class"
    Type: String
    
  PGAutoMinorVersionUpgrade: 
    AllowedValues: 
      - "true"
      - "false"
    Default: "false"
    Description: "Select true to set up auto minor version upgrade."
    Type: String
    
  PGAllocatedStorage:
    ConstraintDescription: must be between 5 and 1024Gb.
    Default: '20'
    Description: The size of the database (Gb)
    MaxValue: '1024'
    MinValue: '5'
    Type: Number
    
  MatillionRealmConName:
    Description: 'Connection Name, Example: administrator@INTERNAL.DOMAIN.COM'
    Type: String
    
  MatillionRealmConPass:
    Description: "The password for the connection username used for initial bind."
    NoEcho: true
    Type: String
    
  MatillionRealmConURL:
    Description: 'The URL to your directory server, Example: ldap://10.10.10.254:389'
    Type: String
    
  MatillionRealmMETLAPIRole:
    Description: "The name of an existing group in the directory server whose users will be allowed to administer Matillion. Role names are case-sensitive."
    Type: String
    
  MatillionRealmMETLAdminRole:
    Description: "The name of an existing group in the directory server whose users will be allowed to administer Matillion. Role names are case-sensitive."
    Type: String
    
  MatillionRealmMETLRole:
    Description: "The name of an existing group in the directory server whose users will be allowed to login. Role names are case-sensitive."
    Type: String
    
  MatillionRealmRoleBase:
    Description: 'The subtree below which groups are stored in the directory tree,
      Example: cn=Groups,dc=INTERNAL,dc=domain,dc=com'
    Type: String
    
  MatillionRealmRoleName:
    Description: 'The LDAP attribute used to identify a group or role, Example: cn'
    Type: String
    
  MatillionRealmRoleSearch:
    Description: 'The LDAP attribute to use to identify groups or roles, Example:
      member={0}'
    Type: String
    
  MatillionRealmUserBase:
    Description: 'The subtree below which users are stored in the directory tree,
      Example: cn=Users,dc=INTERNAL,dc=domain,dc=com'
    Type: String
    
  MatillionRealmUserSearch:
    Description: 'The LDAP attribute to use for identifying users, Example: sAMAccountName={0}'
    Type: String
    
  MatillionRealmUserSubtree:
    AllowedValues:
    - 'true'
    - 'false'
    Default: 'false'
    Description: "Sets the scope of the search. Select true if you wish to search the entire subtree, rooted at the 'User Base' entry. Selecting false (default) requests a lone top-level search."
    Type: String
    
  NewRedshiftCluster: 
    AllowedValues: 
      - "true"
      - "false"
    Default: "true"
    Description: "If true, a redshift cluster stack will be created."
    Type: String
    
  RedshiftDBName:
    Description: The name of the first database to be created when the redshift cluster
      is created
    Type: String
    Default: matillion
    AllowedPattern: "([a-z]|[0-9])+"
    ConstraintDescription: must contain a-z or 0-9 only.
    
  RedshiftDBPort:
    Description: 'The port that Redshift will listen on and that will be allowed through
      the Security Group. '
    Type: String
    Default: '8200'
    
  RedshiftNumberOfNodes:
    Description: The nuber of compute nodes in the redshift cluster.  When cluster
      type is specified as single-node, the NumberOfNodes parameter should be specified
      as 1.  When cluster type is specified as multi-node, the NumberOfNodes parameter
      should be greater than 1
    Type: Number
    Default: '2'
    
  RedshiftNodeType:
    Description: The node type to be provisioned for the redshift cluster
    Type: String
    Default: dc2.large
    AllowedValues:
      - dc2.large
      - dc2.8xlarge
      - ds2.xlarge
      - ds2.8xlarge
    ConstraintDescription: must be a valid RedShift node type.
    
  RedshiftMasterUsername:
    Description: The user name associated with the master user account for the redshift
      cluster that is being created
    Type: String
    Default: matillion
    AllowedPattern: "([a-z])([a-z]|[0-9])*"
    ConstraintDescription: must start with a-z and contain only a-z or 0-9.
    
  RedshiftMasterUserPassword:
    Description: 'The password associated with the master user account for the redshift
      cluster that is being created. '
    Type: String
    NoEcho: 'true'
    MinLength: '1'
    MaxLength: '41'
    Default: 'Welcome123'
    AllowedPattern: >-
     ^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?!._*[@/\\\"']).*$
    ConstraintDescription: must contain only alphanumeric characters.
  
  RedshiftMaintenancewindow:
    Description: Maintenance Window for Redshift Cluster
    Type: String
    Default: 'sat:05:00-sat:05:30'
        
  RedshiftMaxConcurrentCluster:
    Description: Maximum Concurrency Scaling Redshift Clusters
    Type: String
    Default: '1'
    
  RedshiftEncryptionAtRest:
    Description: "Do you want to encrypt database at rest?"
    Type: String
    Default: 'false'
    AllowedValues:
      - true
      - false
    ConstraintDescription: must be true or false.
  
  Redshiftkmskey:
    Description: Existing KMS key ID
    Type: String
    Default: ''
    
  RedshiftSnapshotIdentifier:
    Description: Leave it blank for new cluster. Enter Snapshot Identifier only if you want to restore from snapshot. 
    Type: String
    
  RedshiftSnapshotAccountNumber:
    Description: "AWS Account number of Snapshot (Leave it blank, if snapshot is created in current AWS Account)"
    Type: String
    
  RedshiftNotificationList:
    Type: String
    Description: The Email notification list is used to configure a SNS topic for sending cloudwatch alarm and event notifications
    Default: "abc@xyz.com"
    AllowedPattern: '^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$'
    ConstraintDescription: provide a valid email address.
    
  RedshiftEnableLoggingToS3:
    Default: 'false'
    Type: String
    AllowedValues:
      - true
      - false
    Description: "Do you want to enable logging to S3 bucket?"
    
  RedshiftS3BucketForIAMRole:
    Type: String
    Description: "Enter existing S3 Bucket contains dataset. IAM role will be created and associated to the Redshift cluster with GET and LIST access to this bucket."
    
  QSS3BucketName:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    ConstraintDescription: "Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Default: aws-quickstart
    Description: "S3 bucket name for the Quick Start assets. Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Type: String
    
  QSS3KeyPrefix:
    AllowedPattern: "^[0-9a-zA-Z-/]*$"
    ConstraintDescription: "Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Default: quickstart-amazon-aurora/
    Description: "S3 key prefix for the Quick Start assets. Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Type: String
    
Conditions:
  GovCloudCondition: !Equals 
    - !Ref 'AWS::Region'
    - us-gov-west-1
  EnableBastionAccess: !Equals
    - !Ref EnableBastion
    - "true"
  CreateRedshiftStack: !Equals
    - !Ref NewRedshiftCluster
    - "true"
  IsAcceptedEULA: !Equals
    - !Ref AcceptedEULA
    - "Yes"

Resources:

  VPCStack:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub
        - https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}submodules/quickstart-aws-vpc/templates/aws-vpc.template
        - QSS3Region:
            Fn::If:
            - GovCloudCondition
            - s3-us-gov-west-1
            - s3
      Parameters:
        AvailabilityZones: !Join 
          - ','
          - !Ref AvailabilityZones
        KeyPairName: !Ref KeyPairName
        NumberOfAZs: '2'
        PrivateSubnet1ACIDR: !Ref PrivateSubnet1CIDR
        PrivateSubnet2ACIDR: !Ref PrivateSubnet2CIDR
        PublicSubnet1CIDR: !Ref PublicSubnet1CIDR
        PublicSubnet2CIDR: !Ref PublicSubnet2CIDR
        VPCCIDR: !Ref VPCCIDR
        
  MatillionHAStack:
    Condition: IsAcceptedEULA
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 
        - https://sudhig-cfn-templates.s3.amazonaws.com/quickstart-aws-redshift/templates/matillion_cluster_dev.yml
        - QSS3Region: !If [GovCloudCondition , s3-us-gov-west-1 , s3]
      Parameters:
        ParentStackName: !Ref AWS::StackName
        MatillionEC2InstanceType: !Ref MatillionEC2InstanceType
        KeyPairName: !Ref KeyPairName
        VPCID:
          Fn::GetAtt:
          - VPCStack
          - Outputs.VPCID
        PublicSubnet1: !GetAtt 
          - VPCStack
          - Outputs.PublicSubnet1ID
        PublicSubnet2: !GetAtt 
          - VPCStack
          - Outputs.PublicSubnet2ID
        PrivateSubnet1:
          Fn::GetAtt:
          - VPCStack
          - Outputs.PrivateSubnet1AID
        PrivateSubnet2:
          Fn::GetAtt:
          - VPCStack
          - Outputs.PrivateSubnet2AID
        LBDnsName: !Ref LBDnsName
        RemoteAccessCIDR: !Ref RemoteAccessCIDR
        PGMasterUsername: !Ref PGMasterUsername
        PGMasterUserPassword: !Ref PGMasterUserPassword
        PGDBPort: !Ref PGDBPort
        PGDBName: !Ref PGDBName
        PGInstanceClass: !Ref PGInstanceClass
        PGAllocatedStorage: !Ref PGAllocatedStorage
        PGAutoMinorVersionUpgrade: !Ref PGAutoMinorVersionUpgrade
        MatillionRealmConName: !Ref MatillionRealmConName
        MatillionRealmConPass: !Ref MatillionRealmConPass
        MatillionRealmConURL: !Ref MatillionRealmConURL
        MatillionRealmMETLAPIRole: !Ref MatillionRealmMETLAPIRole
        MatillionRealmMETLAdminRole: !Ref MatillionRealmMETLAdminRole
        MatillionRealmMETLRole: !Ref MatillionRealmMETLRole
        MatillionRealmRoleBase: !Ref MatillionRealmRoleBase
        MatillionRealmRoleName: !Ref MatillionRealmRoleName
        MatillionRealmRoleSearch: !Ref MatillionRealmRoleSearch
        MatillionRealmUserBase: !Ref MatillionRealmUserBase
        MatillionRealmUserSearch: !Ref MatillionRealmUserSearch
        MatillionRealmUserSubtree: !Ref MatillionRealmUserSubtree
        
  RedshiftStack:
    Condition: CreateRedshiftStack
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 
        - https://sudhig-cfn-templates.s3.amazonaws.com/quickstart-aws-redshift/templates/redshift-cluster.template.yml
        - QSS3Region: !If [GovCloudCondition , s3-us-gov-west-1 , s3]
      Parameters:
        ParentStackName: !Ref AWS::StackName
        PrivateSubnet1:
          Fn::GetAtt:
          - VPCStack
          - Outputs.PrivateSubnet1AID
        PrivateSubnet2:
          Fn::GetAtt:
          - VPCStack
          - Outputs.PrivateSubnet2AID
        VPC:
          Fn::GetAtt:
          - VPCStack
          - Outputs.VPCID
        InboundTraffic: !Ref VPCCIDR
        RedshiftDBName: !Ref RedshiftDBName
        RedshiftDBPort: !Ref RedshiftDBPort
        NumberOfNodes: !Ref RedshiftNumberOfNodes
        NodeType: !Ref RedshiftNodeType
        MasterUsername: !Ref RedshiftMasterUsername
        MasterUserPassword: !Ref RedshiftMasterUserPassword
        Maintenancewindow: !Ref RedshiftMaintenancewindow
        MaxConcurrentCluster: !Ref RedshiftMaxConcurrentCluster
        EncryptionAtRest: !Ref RedshiftEncryptionAtRest
        kmskey: !Ref Redshiftkmskey
        SnapshotIdentifier: !Ref RedshiftSnapshotIdentifier
        SnapshotAccountNumber: !Ref RedshiftSnapshotAccountNumber
        NotificationList: !Ref RedshiftNotificationList
        EnableLoggingToS3: !Ref RedshiftEnableLoggingToS3
        S3BucketForRedshiftIAMRole: !Ref RedshiftS3BucketForIAMRole
        
  BastionStack:
    Condition: EnableBastionAccess
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub 
        - https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}submodules/quickstart-linux-bastion/templates/linux-bastion.template
        - QSS3Region: !If [GovCloudCondition , s3-us-gov-west-1 , s3]
      Parameters:
        KeyPairName: !Ref KeyPairName
        PublicSubnet1ID: !GetAtt 
          - VPCStack
          - Outputs.PublicSubnet1ID
        PublicSubnet2ID: !GetAtt 
          - VPCStack
          - Outputs.PublicSubnet2ID
        RemoteAccessCIDR: !Ref RemoteAccessCIDR
        VPCID: !GetAtt 
          - VPCStack
          - Outputs.VPCID
