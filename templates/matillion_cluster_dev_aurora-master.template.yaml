Description: "This cloudformation template creates AWS VPC, Bastion host, Amazon Redshift and Clustered Enterprise version of Matillion softwares."
Metadata:
  LICENSE: EULA - Matillion ETL for Redshift
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: End User License Agreement (EULA) - Matillion ETL for Redshift
      Parameters:
      - AcceptedEULA
    - Label:
        default: VPC Networking configuration
      Parameters:
      - AvailabilityZones
      - VPCCIDR
      - PublicSubnet1CIDR
      - PublicSubnet2CIDR
      - PrivateSubnet1CIDR
      - PrivateSubnet2CIDR
      - RemoteAccessCIDR
    - Label:
        default: Linux bastion configuration
      Parameters:
       - EnableBastion
       - BastionInstanceType
       - EnableTCPForwarding
       - EnableX11Forwarding
       - AlternativeInitializationScript
    - Label:
        default: Matillion EC2 Instance and ALB configuration 
      Parameters:
      - MatillionEC2InstanceType
      - KeyPairName
      - LBDnsName
    - Label:
        default: Matillion Aurora/PostgreSQL repository configuration 
      Parameters:
      - PGEngineVersion
      - PGInstanceClass
      - PGDBName
      - PGDBPort
      - PGMasterUsername
      - PGMasterUserPassword
      - NotificationList
    - Label:
        default: Amazon Redshift configuration
      Parameters:
      - EnableRedshiftStack
      - RedshiftDBName
      - RedshiftDBPort
      - RedshiftNodeType
      - RedshiftNumberOfNodes
      - RedshiftMasterUsername
      - RedshiftMasterUserPassword
      - RedshiftEnableLoggingToS3
      - RedshiftMaxConcurrentCluster
      - RedshiftEncryptionAtRest
      - Redshiftkmskey
      - RedshiftS3BucketForIAMRole
      - RedshiftMaintenancewindow
      - RedshiftSnapshotIdentifier
      - RedshiftSnapshotAccountNumber
    - Label:
        default: Matillion-ETL Realm Configuration
      Parameters:
      - MatillionRealmConName
      - MatillionRealmConPass
      - MatillionRealmConURL
      - MatillionRealmUserBase
      - MatillionRealmUserSearch
      - MatillionRealmRoleBase
      - MatillionRealmRoleName
      - MatillionRealmRoleSearch
      - MatillionRealmUserSubtree
      - MatillionRealmMETLRole
      - MatillionRealmMETLAdminRole
      - MatillionRealmMETLAPIRole
    - Label:
        default: Tag identifiers
      Parameters:
      - TagEnvironment
      - TagName
    - Label:
        default: Quick Start configuration
      Parameters:
      - QSS3BucketName
      - QSS3KeyPrefix
    ParameterLabels:
      AcceptedEULA:
        default: Have you accepted EULA from AWS Marketplace link https://aws.amazon.com/marketplace/pp/B010ED5YF8?
      PGAllocatedStorage:
        default: Storage Size
      MatillionEC2InstanceType:
        default: Matillion Instance Type
      KeyPairName:
        default: Keypair Name
      LBDnsName:
        default: ALB DNS Prefix
      PGDBName:
        default: Aurora/PostgreSQL Database Name
      PGMasterUserPassword:
        default: Aurora/PostgreSQL Master Password
      PGDBPort:
        default: Aurora/PostgreSQL Database Port
      PGEngineVersion:
        default: Aurora/Postgres Engine Version
      PGMasterUsername:
        default: Aurora/PostgreSQL Master Username
      PGInstanceClass:
        default: Aurora/PostgreSQL Instance Class
      EnableBastion:
        default: Create bastion stack
      BastionInstanceType:
        default: Bastion instance type
      EnableTCPForwarding:
        default: Enable TCP forwarding
      EnableX11Forwarding:
        default: Enable X11 forwarding
      PrivateSubnet1CIDR:
        default: Private subnet 1 CIDR
      PrivateSubnet2CIDR:
        default: Private subnet 2 CIDR
      PublicSubnet1CIDR:
        default: Public subnet 1 CIDR
      PublicSubnet2CIDR:
        default: Public subnet 2 CIDR
      QSS3BucketName:
        default: Quick Start S3 bucket name
      QSS3KeyPrefix:
        default: Quick Start S3 key prefix
      VPCCIDR:
        default: VPC CIDR
      EnableRedshiftStack:
        default: Do you want to create Redshift cluster stack? 
      RedshiftDBName:
        default: Redshift Database Name
      RedshiftDBPort:
        default: Redshift Database Port
      RedshiftNodeType:
        default: Node Type for Redshift Cluster
      RedshiftNumberOfNodes:
        default: Number Of Nodes in Redshift Cluster
      RedshiftMasterUsername:
        default: Redshift Master User Name
      RedshiftMasterUserPassword:
        default: Redshift Master User Password
      RedshiftEnableLoggingToS3:
        default: Enable Audit Logging to Amazon S3 for Redshift Database?
      RedshiftMaxConcurrentCluster:
        default: Maximum number of Concurrent Cluster for Redshift
      RedshiftEncryptionAtRest:
        default: Enable Encryption at rest?
      Redshiftkmskey:
        default: KMS Key for Encryption at rest
      RedshiftS3BucketForIAMRole:
        default: Amazon S3 Bucket for Redshift IAM Role 
      NotificationList:
        default: Email address for SNS notification
      RedshiftMaintenancewindow:
        default: Redshift Maintenance window
      RedshiftSnapshotIdentifier:
        default: Redshift Snapshot Identifier to restore Redshift cluster
      RedshiftSnapshotAccountNumber:
        default: AWS Account-ID where the Redshift snapshot was created
      MatillionRealmConName:
        default: Username
      MatillionRealmConPass:
        default: Connection Password
      MatillionRealmConURL:
        default: URL
      MatillionRealmMETLAPIRole:
        default: API Role
      MatillionRealmMETLAdminRole:
        default: Admin Role
      MatillionRealmMETLRole:
        default: Login Role
      MatillionRealmRoleBase:
        default: Role Base
      MatillionRealmRoleName:
        default: Role Name
      MatillionRealmRoleSearch:
        default: Role Search
      MatillionRealmUserBase:
        default: User Base
      MatillionRealmUserSearch:
        default: User Search
      MatillionRealmUserSubtree:
        default: User Subtree
      TagEnvironment:
        default: Environment
      TagName:
        default: Unique friendly name
      AlternativeInitializationScript:
        default: Custom Bootstrap Script
        
Parameters:
    
  AcceptedEULA: 
    AllowedValues: 
      - "Yes"
      - "No"
    Default: "No"
    Description: >- 
        PLEASE READ EULA (https://redshift-support.matillion.com/s/article/2845300) CAREFULLY BEFORE USING THE SOFTWARE.
        Matillion stack can be created only if you have already accepted the EULA of using Matillion ETL for Redshift.
        For accepting EULA, visit AWS marketplace link - https://aws.amazon.com/marketplace/pp/B010ED5YF8.     
    Type: String
    
  VPCCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/16
    Description: CIDR block for the VPC.
    Type: String
    
  AvailabilityZones:
   Description: >-
      List of Availability Zones to use for the subnets in the VPC. Only two
      Availability Zones are used for this deployment, and the logical order of
      your selections is preserved.
   Type: 'List<AWS::EC2::AvailabilityZone::Name>'
    
  PrivateSubnet1CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/19
    Description: CIDR block for private subnet 1 located in Availability Zone 1.
    Type: String
    
  PrivateSubnet2CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.32.0/19
    Description: CIDR block for private subnet 2 located in Availability Zone 2.
    Type: String
    
  PublicSubnet1CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.128.0/20
    Description: CIDR block for the public subnet 1 located in Availability Zone 1.
    Type: String
    
  PublicSubnet2CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.144.0/20
    Description: CIDR block for the public subnet 2 located in Availability Zone 2.
    Type: String
    
  RemoteAccessCIDR:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/([0-9]|[1-2][0-9]|3[0-2]))$"
    ConstraintDescription: "CIDR block parameter must be in the form x.x.x.x/x"
    Description: "Allowed CIDR block for external access to ALB and SSH access to bastion host."
    Type: String
    
  EnableBastion: 
    AllowedValues: 
      - "true"
      - "false"
    Default: "true"
    Description: "If true, a bastion stack will be created."
    Type: String
    
  BastionInstanceType:
    AllowedValues:
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
    Default: t2.micro
    Description: Amazon EC2 instance type for the bastion instance. t2 instance types are not supported for dedicated VPC tenancy.
    Type: String
    
  EnableTCPForwarding:
    Type: String
    Description: Enables/disables TCP forwarding
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
  EnableX11Forwarding:
    Type: String
    Description: Enables/disables X11 forwarding.
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
      
  KeyPairName:
    Description: A public/private key pair, which allows you to connect securely to your instance after it launches. This is the key pair you created in your preferred AWS Region; see the Technical requirements section. If you do not have one in this AWS Region, create it before continuing.
    Type: 'AWS::EC2::KeyPair::KeyName'
    
  AlternativeInitializationScript:
    AllowedPattern: ^http.*|^$
    ConstraintDescription: URL must begin with http
    Description: Optional. Specify custom bootstrap script AWS S3 location to run during bastion host setup
    Default: ''
    Type: String
    
  MatillionEC2InstanceType:
    AllowedValues:
    - m5.large
    - m5.xlarge
    - m3.medium
    - t2.medium
    - t3.medium
    - m3.large
    - m4.large
    - m5.large
    - r3.large
    - r4.large
    - m3.xlarge
    - m4.xlarge
    - m5.xlarge
    - r3.xlarge
    - r4.xlarge
    - t3.xlarge
    - x1e.xlarge
    - m5.2xlarge
    - r3.2xlarge
    Default: m5.large
    Description: Matillion instance(s) size. Larger sizes allow for running more concurrent
      tasks, See https://www.matillion.com/pricing/etl-for-redshift/ for more info.
    Type: String
    
  LBDnsName:
    Default: matillion
    Description: 'Load Balancer DNS Name Prefix, Example: [matillion]-1731869672.eu-west-1.elb.amazonaws.com'
    Type: String
    
  MatillionRealmConName:
    Description: 'Connection Name, Example: administrator@INTERNAL.DOMAIN.COM'
    Type: String
    
  MatillionRealmConPass:
    Description: "The password for the connection username used for initial bind."
    NoEcho: true
    Type: String
    
  MatillionRealmConURL:
    Description: 'The URL to your directory server, Example: ldap://10.10.10.254:389'
    Type: String
    
  MatillionRealmMETLAPIRole:
    Description: "The name of an existing group in the directory server whose users will be allowed to administer Matillion. Role names are case-sensitive."
    Type: String
    
  MatillionRealmMETLAdminRole:
    Description: "The name of an existing group in the directory server whose users will be allowed to administer Matillion. Role names are case-sensitive."
    Type: String
    
  MatillionRealmMETLRole:
    Description: "The name of an existing group in the directory server whose users will be allowed to login. Role names are case-sensitive."
    Type: String
    
  MatillionRealmRoleBase:
    Description: 'The subtree below which groups are stored in the directory tree,
      Example: cn=Groups,dc=INTERNAL,dc=domain,dc=com'
    Type: String
    
  MatillionRealmRoleName:
    Description: 'The LDAP attribute used to identify a group or role, Example: cn'
    Type: String
    
  MatillionRealmRoleSearch:
    Description: 'The LDAP attribute to use to identify groups or roles, Example:
      member={0}'
    Type: String
    
  MatillionRealmUserBase:
    Description: 'The subtree below which users are stored in the directory tree,
      Example: cn=Users,dc=INTERNAL,dc=domain,dc=com'
    Type: String
    
  MatillionRealmUserSearch:
    Description: 'The LDAP attribute to use for identifying users, Example: sAMAccountName={0}'
    Type: String
    
  MatillionRealmUserSubtree:
    AllowedValues:
    - 'true'
    - 'false'
    Default: 'false'
    Description: "Sets the scope of the search. Select true if you wish to search the entire subtree, rooted at the 'User Base' entry. Selecting false (default) requests a lone top-level search."
    Type: String
    
  PGDBName:
    AllowedPattern: "([a-z]|[0-9])+"
    Default: matillion
    Description: Aurora/Postgres database name for Matillion repository
      repository.
    Type: String
    
  PGMasterUserPassword:
    AllowedPattern: '(?=^.{6,255}$)((?=.*\\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*'
    Description: "Min 8 chars. Must include 1 uppercase, 1 lowercase, 1 number, 1 (non / @ \" ') symbol"
    NoEcho: true
    Type: String
    
  PGDBPort:
    Default: '8201'
    Description: Specify the TCP/IP port that the DB instance will use for application
      connections.
    MaxValue: 65535
    MinValue: 1150
    Type: Number
    
  PGMasterUsername:
    AllowedPattern: "^[a-zA-Z]{1}[a-z0-9]*"
    Default: matillion
    Description: Initial Postgres Username. This user will be an admin role.
    Type: String
    
  PGEngineVersion:
    Description: Select Database Engine Version
    Type: String
    Default: 9.6.12
    AllowedValues:
      - 9.6.12
    
  PGInstanceClass:
    AllowedValues:
      - db.r5.large
      - db.r5.xlarge
      - db.r5.2xlarge
      - db.r5.4xlarge
      - db.r5.12xlarge
      - db.r5.24xlarge
      - db.r4.large
      - db.r4.xlarge
      - db.r4.2xlarge
      - db.r4.4xlarge
      - db.r4.8xlarge
      - db.r4.16xlarge
    Default: db.r5.large
    Description: Database instance class
    Type: String
    
  EnableRedshiftStack: 
    AllowedValues: 
      - "true"
      - "false"
    Default: "true"
    Description: Enables or disables creation of a Redshift stack. If true, a Redshift stack will be created. 
    Type: String
    
  RedshiftDBName:
    Description: The name of the first database to be created when the cluster is created.
      is created
    Type: String
    Default: matillion
    AllowedPattern: "([a-z]|[0-9])+"
    ConstraintDescription: must contain a-z or 0-9 only.
    
  RedshiftDBPort:
    Description: The port number on which the cluster accepts incoming connections.
    Type: String
    Default: '8200'
    
  RedshiftNumberOfNodes:
    Description: The number of compute nodes in the cluster. For multi-node clusters, the NumberOfNodes parameter must be greater than 1.
    Type: Number
    Default: '2'
    
  RedshiftNodeType:
    Description: The type of node to be provisioned
    Type: String
    Default: dc2.large
    AllowedValues:
      - dc2.large
      - dc2.8xlarge
      - ds2.xlarge
      - ds2.8xlarge
    ConstraintDescription: must be a valid RedShift node type.
    
  RedshiftMasterUsername:
    Description: The user name that is associated with the master user account for the cluster that is being created.
    Type: String
    Default: matillion
    AllowedPattern: '([a-z])([a-z]|[0-9])*'
    ConstraintDescription: must start with a-z and contain only a-z or 0-9.
    
  RedshiftMasterUserPassword:
    Description: >-
        The password that is associated with the master user account for the cluster that is being created. Must have at least 8 characters and no more than 64 characters, 
        and must include 1 uppercase letter, 1 lowercase letter, 1 number, and 1 symbol (excluding / @ \" ').
    NoEcho: true
    Type: String
    MinLength: '8'
    MaxLength: '64'
    AllowedPattern: '(?=^.{6,255}$)((?=.*\\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*'
    ConstraintDescription: >-
       Enter alphanumeric password for the master user. The password must contain 8 to 64 printable ASCII characters, excluding: /, ", \'', \ and @. It must contain one uppercase letter, one lowercase letter, and one number.
 
  RedshiftMaintenancewindow:
    Description: The maintenance window for the Redshift cluster.
    Type: String
    Default: 'sat:05:00-sat:05:30'
        
  RedshiftMaxConcurrentCluster:
    Description: The maximum number of concurrency scaling Redshift clusters.
    Type: String
    Default: '1'
    
  RedshiftEncryptionAtRest:
    Description: Enables or disables encryption at rest of the Redshift database.
    Type: String
    Default: 'false'
    AllowedValues:
      - true
      - false
    ConstraintDescription: must be true or false.
  
  Redshiftkmskey:
    Description: The existing KMS key ID for encrypting Redshift database at-rest.
    Type: String
    Default: ''
    
  RedshiftSnapshotIdentifier:
    Description: The Redshift snapshot identifier. Leave this blank for a new cluster. Enter the snapshot identifier, only if you want to restore from a snapshot.
    Type: String
    Default: ''
    
  RedshiftSnapshotAccountNumber:
    Description: The AWS account number where the Redshift snapshot was created. Leave this blank, if the snapshot was created in the current AWS account.
    Type: String
    Default: ''
    
  NotificationList:
    Type: String
    Description: The email notification list that is used to configure an SNS topic for sending CloudWatch alarm and event notifications.
    Default: "ops@company.com"
    AllowedPattern: '^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$'
    ConstraintDescription: provide a valid email address.
    
  RedshiftEnableLoggingToS3:
    Default: 'false'
    Type: String
    AllowedValues:
      - true
      - false
    Description: Enables or disables logging to an S3 bucket.  To enable logging, select True.
    
  RedshiftS3BucketForIAMRole:
    Type: String
    Description: The existing Amazon S3 bucket. An IAM role will be created and associated to the Redshift cluster with GET and LIST access to this bucket.
    Default: ''
    
  QSS3BucketName:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    ConstraintDescription: "Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Default: sudhig-cfn-templates
    Description: "S3 bucket name for the Quick Start assets. Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Type: String
    
  QSS3KeyPrefix:
    AllowedPattern: "^[0-9a-zA-Z-/]*$"
    ConstraintDescription: "Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Default: quickstart-amazon-redshift/
    Description: "S3 key prefix for the Quick Start assets. Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Type: String
    
  TagName:
    Type: String
    Description: Unique friendly name as required by the your company tagging strategy document and will be added to tag.
    Default: 'matillion-qs'
  TagEnvironment:
    Type: String
    AllowedValues:
      - dev
      - test
      - pre-prod
      - prod
      - none
    Default: test
    Description: The environment tag is used to designate the Environment Stage of the associated AWS resource.
    
Conditions:
  GovCloudCondition: !Equals 
    - !Ref 'AWS::Region'
    - us-gov-west-1
  EnableBastionAccess: !Equals
    - !Ref EnableBastion
    - "true"
  CreateRedshiftStack: !Equals
    - !Ref EnableRedshiftStack
    - "true"
  IsAcceptedEULA: !Equals
    - !Ref AcceptedEULA
    - "Yes"

Resources:

  VPCStack:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub
        - https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}submodules/quickstart-aws-vpc/templates/aws-vpc.template
        - QSS3Region:
            Fn::If:
            - GovCloudCondition
            - s3-us-gov-west-1
            - s3
      Parameters:
        AvailabilityZones: !Join 
          - ','
          - !Ref AvailabilityZones
        KeyPairName: !Ref KeyPairName
        NumberOfAZs: '2'
        PrivateSubnet1ACIDR: !Ref PrivateSubnet1CIDR
        PrivateSubnet2ACIDR: !Ref PrivateSubnet2CIDR
        PublicSubnet1CIDR: !Ref PublicSubnet1CIDR
        PublicSubnet2CIDR: !Ref PublicSubnet2CIDR
        VPCCIDR: !Ref VPCCIDR
        
  MatillionStack:
    Condition: IsAcceptedEULA
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 
        - https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}templates/matillion_cluster_dev_aurora.yaml
        - QSS3Region: !If [GovCloudCondition , s3-us-gov-west-1 , s3]
      Parameters:
        MatillionEC2InstanceType: !Ref MatillionEC2InstanceType
        KeyPairName: !Ref KeyPairName
        VPCID:
          Fn::GetAtt:
          - VPCStack
          - Outputs.VPCID
        PublicSubnet1: !GetAtt 
          - VPCStack
          - Outputs.PublicSubnet1ID
        PublicSubnet2: !GetAtt 
          - VPCStack
          - Outputs.PublicSubnet2ID
        PrivateSubnet1:
          Fn::GetAtt:
          - VPCStack
          - Outputs.PrivateSubnet1AID
        PrivateSubnet2:
          Fn::GetAtt:
          - VPCStack
          - Outputs.PrivateSubnet2AID
        LBDnsName: !Ref LBDnsName
        AcceptedEULA: !Ref AcceptedEULA
        RemoteAccessCIDR: !Ref RemoteAccessCIDR
        PGMasterUsername: !Ref PGMasterUsername
        PGMasterUserPassword: !Ref PGMasterUserPassword
        PGDBPort: !Ref PGDBPort
        PGDBName: !Ref PGDBName
        PGEngineVersion: !Ref PGEngineVersion
        PGInstanceClass: !Ref PGInstanceClass
        NotificationList: !Ref NotificationList
        TagEnvironment: !Ref TagEnvironment
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        MatillionRealmConName: !Ref MatillionRealmConName
        MatillionRealmConPass: !Ref MatillionRealmConPass
        MatillionRealmConURL: !Ref MatillionRealmConURL
        MatillionRealmMETLAPIRole: !Ref MatillionRealmMETLAPIRole
        MatillionRealmMETLAdminRole: !Ref MatillionRealmMETLAdminRole
        MatillionRealmMETLRole: !Ref MatillionRealmMETLRole
        MatillionRealmRoleBase: !Ref MatillionRealmRoleBase
        MatillionRealmRoleName: !Ref MatillionRealmRoleName
        MatillionRealmRoleSearch: !Ref MatillionRealmRoleSearch
        MatillionRealmUserBase: !Ref MatillionRealmUserBase
        MatillionRealmUserSearch: !Ref MatillionRealmUserSearch
        MatillionRealmUserSubtree: !Ref MatillionRealmUserSubtree
        
  RedshiftStack:
    Condition: CreateRedshiftStack
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 
        - https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}templates/redshift.template.yaml
        - QSS3Region: !If [GovCloudCondition , s3-us-gov-west-1 , s3]
      Parameters:
        Subnet1ID:
          Fn::GetAtt:
          - VPCStack
          - Outputs.PrivateSubnet1AID
        Subnet2ID:
          Fn::GetAtt:
          - VPCStack
          - Outputs.PrivateSubnet2AID
        VPCID:
          Fn::GetAtt:
          - VPCStack
          - Outputs.VPCID
        RemoteAccessCIDR: !Ref VPCCIDR
        PubliclyAccessible: 'false'
        DatabaseName: !Ref RedshiftDBName
        RedshiftClusterPort: !Ref RedshiftDBPort
        NumberOfNodes: !Ref RedshiftNumberOfNodes
        NodeType: !Ref RedshiftNodeType
        MasterUsername: !Ref RedshiftMasterUsername
        MasterUserPassword: !Ref RedshiftMasterUserPassword
        Maintenancewindow: !Ref RedshiftMaintenancewindow
        MaxConcurrentCluster: !Ref RedshiftMaxConcurrentCluster
        EncryptionAtRest: !Ref RedshiftEncryptionAtRest
        kmskey: !Ref Redshiftkmskey
        SnapshotIdentifier: !Ref RedshiftSnapshotIdentifier
        SnapshotAccountNumber: !Ref RedshiftSnapshotAccountNumber
        NotificationList: !Ref NotificationList
        EnableLoggingToS3: !Ref RedshiftEnableLoggingToS3
        S3BucketForRedshiftIAMRole: !Ref RedshiftS3BucketForIAMRole
        GlueCatalogDatabase: ''
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        TagName: !Ref TagName
        TagEnvironment: !Ref TagEnvironment
        
  BastionStack:
    Condition: EnableBastionAccess
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Sub 
        - https://${QSS3BucketName}.${QSS3Region}.amazonaws.com/${QSS3KeyPrefix}submodules/quickstart-linux-bastion/templates/linux-bastion.template
        - QSS3Region: !If [GovCloudCondition , s3-us-gov-west-1 , s3]
      Parameters:
        KeyPairName: !Ref KeyPairName
        PublicSubnet1ID: !GetAtt 
          - VPCStack
          - Outputs.PublicSubnet1ID
        PublicSubnet2ID: !GetAtt 
          - VPCStack
          - Outputs.PublicSubnet2ID
        VPCID: !GetAtt 
          - VPCStack
          - Outputs.VPCID
        RemoteAccessCIDR: !Ref RemoteAccessCIDR
        BastionBanner: 'https://aws-quickstart.s3.amazonaws.com/quickstart-linux-bastion/scripts/banner_message.txt'
        EnableBanner: 'true'
        BastionTenancy: 'default'
        BastionInstanceType: !Ref BastionInstanceType
        AlternativeInitializationScript: !Ref AlternativeInitializationScript
        EnableX11Forwarding: !Ref EnableX11Forwarding
        EnableTCPForwarding: !Ref EnableTCPForwarding

Outputs:
  MatillionALBURL:
    Description: Public Endpoint for Matillion Instance
    Value:
      Fn::GetAtt:
      - MatillionStack
      - Outputs.ALBURL
  RDSJDBCConnectionString:
    Description: JDBC connection string for Matillion RDS/Postgres DB
    Value:
      Fn::GetAtt:
      - MatillionStack
      - Outputs.RDSJDBCConnectionString
  RedshiftClusterEndpoint:
    Condition: CreateRedshiftStack
    Description: Redshift Cluster endpoint
    Value:
      Fn::GetAtt:
      - RedshiftStack
      - Outputs.RedshiftClusterEndpoint
